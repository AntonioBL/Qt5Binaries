#!/bin/bash

# Run this file inside an Ubuntu Bionic Docker image
# Run this file after Recipe1, loading the image generated by the previous job

#Set architecture: amd64, i386
ARCH=$1

set -e # Halt on error
set -x # Be verbose

cd qt5source
cd build

# Configure Qt
../configure -release -prefix /qt5 -opensource -confirm-license -platform linux-g++ -make examples \
-nomake tests -skip qt3d -skip qtcanvas3d -skip qtdatavis3d -skip qtdoc -skip qtdocgallery -skip qtgamepad \
-skip qtpurchasing -skip qtsensors -cups -accessibility -opengl desktop -gtk -pkg-config

# -opengl dynamic ?

make -j $(($(nproc)+1))
make install -j $(($(nproc)+1))

echo 'Compilation and installation completed'

# Allow non-root users to access the files
chmod -R a+rwx /qt5

tar -zcf qt5linux_${ARCH}.tar.gz /qt5 
mv qt5linux_${ARCH}.tar.gz /output

chmod -R a+rwx /output

echo 'Recipe2 completed'
