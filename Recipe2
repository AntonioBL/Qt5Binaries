#!/bin/bash

# Run this file inside an Ubuntu Bionic Docker image
# Run this file after Recipe1, loading the image generated by the previous job

#Set architecture: amd64, i386
ARCH=$1

set -e # Halt on error
set -x # Be verbose

cd qt5source
mkdir build
cd build

# Configure Qt WebEngine
/qt5/bin/qmake ../qtwebengine -- --webengine-spellchecker=no

# -opengl dynamic ?

export NINJAJOBS=-j$(($(nproc))) 
timeout 300m make -j $(($(nproc))) || true
# make install -j $(($(nproc)+1))

# echo 'Compilation and installation completed'

# Allow non-root users to access the files
# chmod -R a+rwx /qt5

# tar -zcf qt5linux_${ARCH}.tar.gz /qt5 
# mv qt5linux_${ARCH}.tar.gz /output

# chmod -R a+rwx /output


# Cleanup Docker image
apt-get clean autoclean
apt-get autoremove --purge -y
rm -rf /tmp/* /var/{cache,log,backups}/* /var/lib/apt/*

# echo 'Recipe2 completed'
